const { createMachine, interpret, assign } = require("xstate");

const Characters = require("./characters");
const moment = require("moment");
const l = require("../logger");
const { getSpeakFunction } = require("./models/bun");

const STATES = {
  WITH_BUN: "with-bun",
  WITHOUT_BUN: "without-bun",
  NORTH_FLOREST_01: "north-florest-01",
};

/**
 *
 * @param {*} user - The current user
 * @param {*} responder - A function that responds to clients
 * @returns
 */
module.exports = (user, responder) => {
  /**
   * A function of the initialState and context
   */
  return (initialState, ctx = {}) => {
    const initial = initialState ?? STATES.WITH_BUN;
    const context = { ...ctx, name: user?.name?.givenName };

    // const increaseSteps = assign({ steps: (context) => context.steps + 1 })

    const states = {
      [STATES.WITH_BUN]: {
        entry: assign({ speakTo: (context) => getSpeakFunction(context) }),
        on: {
          // WITH BUN
          startGame: {
            target: [STATES.WITH_BUN],
            actions: ["startGame"],
          },
          speak: {
            target: [STATES.WITH_BUN],
            actions: async (context, { prompt }) => {
              const { intent, answer } = await context.speakTo?.(prompt);

              if (intent == "None") {
                responder(
                  {
                    worldAdd: {
                      interactive: true,
                      animate: true,
                      prompt: "N√£o entendi o que voc√™ quis dizer. Precisa de $[ajuda](ui:help)$?",
                      who: Characters.BUN,
                    },
                  },
                  false,
                );
                return;
              } else {
                responder(
                  {
                    worldAdd: {
                      interactive: true,
                      animate: true,
                      prompt: answer,
                      who: Characters.BUN,
                    },
                  },
                  false,
                );
              }
            },
          },
          // GO TO FLOREST
          "action.goNorth": {
            target: [STATES.NORTH_FLOREST_01],
            actions: ["goNorthFlorest"],
          },
        },
      },
      [STATES.WITHOUT_BUN]: {
        "action.goNorth": {
          target: [STATES.NORTH_FLOREST_01],
          actions: ["goNorthFlorest"],
        },
        "action.apologize": {
          target: [STATES.WITHOUT_BUN],
          actions: ["apologize"],
        },
      },
      [STATES.NORTH_FLOREST_01]: {
        // entry: [increaseSteps],
        on: {
          "action.goSouth": [STATES.WITH_BUN],
          // actions: [increaseSteps]
        },
      },
    };

    const actions = {
      tail: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Sim, um rabo longo com fios pretos na ponta, mas como te disse, n√£o vi muita coisa, posso estar enganado.`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      apologize: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Voc√™ voltou para se desculpar com ${characterToToken(
        //       Characters.BUN,
        //     )}, mas ele n√£o estava mais l√°! Voc√™ se lembra vagamente que ele comentou algo sobre ir para o norte.`,
        //     who: null,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      curse: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `V√° voc√™, e n√£o fale mais comigo.`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
        // responder({
        //   worldAdd: {
        //     prompt: `${characterToToken(Characters.BUN)} sai irritado e apressado, te xingando para a cidade toda.`,
        //     who: null,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      complaining: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `${user?.givenName?.name}, n√£o se irrite! Eu posso te ajudar. Tente me perguntar, por exemplo, "o que √© a cidade de Mui?"`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      help: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Ajuda? Claro!`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
        // responder({
        //   worldAdd: {
        //     prompt: `Voc√™ sempre pode me pedir ajuda. Para falar comigo, digite abaixo. Eu sou bem esperto, se eu souber te responder, responderei com prazer. Tente dizer, por exemplo, "o que √© a cidade de Mui?".`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      hello: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Ol√°, viajante, voc√™ poderia me ajudar?!`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      ofCourse: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Aaaah, muito obrigado! Se quiser eu posso te falar sobre como era o monstro, ou sobre a cidade da qual eu sou.`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      nope: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Ent√£o v√° @* !%#@*! E n√£o fale mais comigo`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      howAreYou: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Bem n√£o estou, claramente! üò†`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      niceToMeetYou: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `O prazer de te conhecer √© meu, ${user?.givenName?.name}! Algo em que possa ajud√°-lo?`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      bye: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `At√© logo!`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
        // responder({
        //   worldAdd: {
        //     prompt: `Voc√™ v√™ ${characterToToken(Characters.BUN)} indo embora!`,
        //     who: null,
        //     interactive: true,
        //     animate: true,
        //   },
        // });
      },
      startGame: async (context, event) => {
        const name = user.name?.givenName;
        const now = new Date();

        let day = now.getHours() <= 12 ? "Nesta manh√£" : now.getHours() <= 18 ? "Nesta tarde" : "Nesta noite";

        // responder({
        //   worldAdd: {
        //     prompt: `Ol√°, $[${name}](ui:who_is,${Characters.PLAYER.id})$, me chamo ${characterToToken(Characters.BUN)}`,
        //     who: Characters.BUN,
        //     interactive: true,
        //     animate: true,
        //   },
        // });

        // responder({
        //   worldAdd: {
        //     prompt: `${day} eu estava em uma pequena cidade ao leste de $[Mui](ui:tip,city-mui)$, de onde sou, quando um monstro roubou minha $[cesta de ovos](ui:tip,egg-basket)$, e nem tive tempo de ir atr√°s dele. A √∫ltima coisa que me lembro √© de v√™-lo indo em $[dire√ß√£o ao norte](ui:tip,directions-north)$. Ser√° que voc√™ consegue me ajudar?`,
        //     who: Characters.BUN,
        //     animate: true,
        //     interactive: true,
        //   },
        // });
      },
      talkAboutMuiGuild: () => {
        responder({
          worldAdd: {
            prompt: `A cidade de Mui √© uma cidade relativamente nova, e √© onde eu moro atualmente. Ela √© extremamente bem estruturada, e de f√°cil acesso. Talvez voc√™ deva passar por ela, ela fica indo em dire√ß√£o ao sul, ap√≥s sair do p√¢ntano de Java.`,
            who: Characters.BUN,
            animate: true,
            interactive: true,
            fsm: {
              id: "L01_DUNGEON",
              state: STATES.WITH_BUN,
            },
          },
        });
      },
      talkAboutBasketOfEggs: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Aaaah, minha cesta de ovos. Eu iria distribu√≠-los at√© a p√°scoa, mas ${
        //       moment().isBefore(moment("2023-04-09"))
        //         ? "ainda h√° tempo. Se voc√™ encontr√°-la, talvez eu possa te recompensar com um desses ovos."
        //         : "n√£o h√° mais tempo!"
        //     }`,
        //     who: Characters.BUN,
        //     animate: true,
        //     interactive: true,
        //     fsm: {
        //       id: "L01_DUNGEON",
        //       state: STATES.WITH_BUN,
        //     },
        //   },
        // });
      },
      talkAboutMonsterName: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Seu nome? Desconhecido. Relatos vieram de todas as dire√ß√µes, guerreiros bravos da guilda $[Vercelida](ui:tip,guilds)$ e da $[Red Ruby](ui:tip,guilds)$ foram vistos lutando contra a besta, sabendo de seu imenso poder.`,
        //     who: Characters.BUN,
        //     animate: true,
        //     interactive: true,
        //     fsm: {
        //       id: "L01_DUNGEON",
        //       state: STATES.WITH_BUN,
        //     },
        //   },
        // });
      },
      talkAboutMonsterFace: () => {
        // responder({
        //   worldAdd: {
        //     prompt: `Eu n√£o vi o seu rosto, ele parecia grande e feio, talvez um her√≥i de outrora. Nunca se sabe os inimigos que encontraremos, n√£o √© mesmo? A √∫nica coisa que me lembro, antes de desmaiar, foi de ver seu rabo longo balan√ßando.`,
        //     who: Characters.BUN,
        //     animate: true,
        //     interactive: true,
        //     fsm: {
        //       id: "L01_DUNGEON",
        //       state: STATES.WITH_BUN,
        //     },
        //   },
        // });
      },
      goNorthFlorest: async (context, event) => {
        responder({
          worldAdd: {
            prompt: `Voc√™ foi para o norte, voc√™ v√™ uma floresta branca e ouve barulhos. Os animais correm para uma clareira branca, ao leste, e voc√™ v√™ um objeto brilhante no ch√£o.`,
            interactive: true,
            animate: true,
            fsm: {
              id: "L01_DUNGEON",
              state: STATES.NORTH_FLOREST_01,
            },
            context,
          },
        });
      },
    };

    const fsm = createMachine(
      {
        preserveActionOrder: true,
        predictableActionArguments: true,
        id: "main",
        context,
        initial,
        states,
      },
      {
        actions,
      },
    );

    // Transitions
    return interpret(fsm).onTransition((state) => l.debug(`FSM transitioned to ${state.value} with context ${JSON.stringify(state.context, null, 2)}`));
  };
};
